% A ConTeXt document [master document: literateProgs.tex]

\startchapter[title=The capture and manipulation of code]

\startMkIVCode

\installnamespac{LitProgs}

\installcommandhandler \????LitProgs {LitProgs} \????LitProgs

\appendtoks
  \letvalue{oldStop\currentLitProgs}=\getvalue{\e!stop\currentLitProgs}
  \setuevalue{\e!stop \currentLitProgs}{%
    \getvalue{oldStop \currentLitProgs}%
    \addLitProgsCode[\currentLitProgs]}
  \setuevalue{create\currentLitProgs File}{\createLitProgs[\currentLitProgs]}
\to \everydefineLitProgs

\def\addLitProgsCode{%
  \directlua{thirddata.literateProgs.addCode(\currentLitProgs,
                                             \somethingelse,
                                             '_typing_')}
}

\def\createLitProgsFile{%
  \directlua{thirddata.literateProgs.createCodeFile(\currentLitProgs,
                                                    \somethingElse,
                                                    '#1')}
}

\stopMkIVCode

\startLuaCode

function litProgs.addCode(cType, cSubType, bufferName)
  local bufferContents = buffers.getcontent(bufferName):gsub("\13", "\n")
  code[cType]          = code[cType] or { }
  local codeType       = code[codeType]
  codeType[cSubType]   = codeType[cSubType] or { }
  local codeSubType    = codeType[cSubType]
  table_insert(codeSubType, bufferContents)
end

function litProgs.createCodeFile(cType, cSubType, aFilePath)
  -- here be dragons! -- how do we pass in cType and cSubType
  renderFile(aFilePath, litProgs.templates.lua.file)
  -- here be dragons!
end


\stopLuaCode

\stopchapter