% A ConTeXt document [master document: literateProgs.tex]

\startchapter[title=Lua Templates]

\startMkIVCode

%D \section{Template environment}

%D \subsection{Examples}

%D \subsection{Implementation: start}

\definetyping[LuaTemplate]
\setuptyping[Template][option=lua]

%D \subsection{Implementation: stop}

\let\oldStopLuaTemplate=\stopLuaTemplate
\def\stopLuaTemplate{%
  \oldStopLuaTemplate%
  \directlua{thirddata.literateProgs.addLuaTemplate('_typing_')}}

%D \subsection{Implementation: create file}

\def\createTemplateFile[#1]{
  \directlua{thirddata.literateProgs.createLuaTemplateFile('#1')}
}

\stopMkIVCode

\startLuaCode

function litProgs.addLuaTemplate(bufferName)
  local bufferContents = buffers.getcontent(bufferName):gsub("\13", "\n")
  tInsert(code.templates, bufferContents)
end

function litProgs.createLuaTemplateFile(aFilePath)
  renderFile(aFilePath, litProgs.templates.templates.file)
end

\stopLuaCode

\startLuaTemplate

templates.templates.file = [=[
{{ return table.concat(thirddata.literateProgs.code.templates, "\n\n") }}
]=]

\stopLuaTemplate

\stopchapter