% A ConTeXt document [master document: literateProgs.tex]

\startchapter[title=Lua Templates]

\startMkIVCode
\definetyping[LuaTemplate]
\setuptyping[Template][option=lua]

\let\oldStartLuaTemplate=\startLuaTemplate
\def\startLuaTemplate{%
  \directlua{thirddata.literateProgs.markLuaTemplateOrigin()}%
  \oldStartLuaTemplate%
}

\let\oldStopLuaTemplate=\stopLuaTemplate
\def\stopLuaTemplate{%
  \oldStopLuaTemplate%
  \directlua{thirddata.literateProgs.addLuaTemplate('_typing_')}}

\def\createTemplateFile[#1]{
  \directlua{thirddata.literateProgs.createLuaTemplateFile('#1')}
}
\stopMkIVCode

\startLuaCode
function litProgs.markLuaTemplateOrigin()
  tInsert(code.templates,
    sFmt('-- from file: %s after line: %s',
      status.filename,
      toStr(
        mFloor(
          status.linenumber/code.lineModulus
        )*code.lineModulus
      )
    )
  )
end

function litProgs.addLuaTemplate(bufferName)
  local bufferContents = buffers.getcontent(bufferName):gsub("\13", "\n")
  tInsert(code.templates, bufferContents)
end

function litProgs.createLuaTemplateFile(aFilePath)
  tInsert(code.templates, 1, '-- A Lua template file')
  renderCodeFile(aFilePath, code.templates)
end
\stopLuaCode

\stopchapter