% A ConTeXt document [master document: literateProgs.tex]

\startchapter[title=Lakefile]

We use a slightly updated version of Steve Donovan's Lakefile tool to 
drive the creation of the various files required by any given 
\type{t-literate-progs} managed \ConTeXt\ program. 

\startMkIVCode
\def\addMainDocument#1{
  \directlua{
    thirddata.literateProgs.addMainDocument('#1')
  }
}

\def\addSubDocument#1{
  \directlua{
    thirddata.literateProgs.addSubDocument('#1')
  }
}

\def\addDocumentDirectory#1{
  \directlua{
    thirddata.literateProgs.addDocumentDirectory('#1')
  }
}

\def\addConTeXtModuleDirectory#1{
  \directlua{
    thirddata.literateProgs.addConTeXtModuleDirectory('#1')
  }
}
\stopMkIVCode

\startLuaCode
local function addMainDocument(aDocument)
  build.mainDoc = aDocument
end

litProgs.addMainDocument = addMainDocument

local function addSubDocument(aDocument)
  build.subDocs = build.subDocs or { }
  tInsert(build.subDocs, aDocument)
end

litProgs.addSubDocument = addSubDocument

local function addDocumentDirectory(aDirectory)
  build.docDir   = aDirectory
  build.buildDir = aDirectory:gsub('[^/]+', '..')
end

litProgs.addDocumentDirectory = addDocumentDirectory

local function addConTeXtModuleDirectory(aDirectory)
  build.contextModuleDir = aDirectory
end

litProgs.addConTeXtModuleDirectory = addConTeXtModuleDirectory
\stopLuaCode

\startMkIVCode
\def\compileLakefile#1{
  \directlua{
    thirddata.literateProgs.compileLakefile('#1')
  }
}
\stopMkIVCode

\startLuaCode
local function compileLakefile(aCodeStream)
  texio.write(lPPrint(build))
  setCodeStream('Lakefile', aCodeStream)
  markCodeOrigin('Lakefile')
  local lfContents = {}
  tInsert(lfContents, "local docDir = '"..build.docDir.."'")
  tInsert(lfContents, "local moduleDir = '"..build.contextModuleDir.."'")
  tInsert(lfContents, 'local docFiles = {')
  tInsert(lfContents, "  '"..build.mainDoc.."',")
  for i, aSubDoc in ipairs(build.subDocs) do
    tInsert(lfContents, "  '"..aSubDoc.."',")
  end
  tInsert(lfContents, '}')
  addCodeDefault('Lakefile', tConcat(lfContents, '\n'))
end

litProgs.compileLakefile = compileLakefile
\stopLuaCode

\startLakefile
--local contextDoc = 
--  'cd '..docDir..' ; context literateProgs.tex '

--local srcTargets = {
--  't-literate-progs.mkiv',
--  't-literate-progs.lua',
--  't-literate-progs-templates.lua'
--}

local buildTargets   = { }
local diffTargets    = { }
local installTargets = { }

for i, aTarget in ipairs(moduleTargets) do

  table.insert(buildTargets, target(
    'build/'..aTarget,
    srcFiles,
    contextDoc
  ))

  table.insert(diffTargets, target(
    'diff-'..aTarget,
    'build/'..aTarget,
    'diff $(DEPENDS) '..moduleDir..'/'..aTarget
  ))

  table.insert(installTargets, target(
    moduleDir..'/'..aTarget,
    'build/'..aTarget,
    'cp $(DEPENDS) $(TARGET)'
  ))
end

table.insert(buildTargets, target(
  'build/lakefile',
  srcFiles,
  contextDoc
))

table.insert(diffTargets, target(
  'diff-lakefile',
  'build/lakefile',
  'diff $(DEPENDS) lakefile'
))

table.insert(installTargets, target(
  'lakefile',
  'build/lakefile',
  'cp $(DEPENDS) $(TARGET)'
))

target('install', installTargets)

target('diff', diffTargets)

default(buildTargets)
\stopLakefile

\stopchapter