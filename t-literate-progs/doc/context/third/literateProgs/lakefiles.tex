% A ConTeXt document [master document: literateProgs.tex]

\startchapter[title=Lakefile]

We use a slightly updated version of Steve Donovan's Lakefile tool to 
drive the creation of the various files required by any given 
\type{t-literate-progs} managed \ConTeXt\ program. 

\startMkIVCode
\def\addMainDocument#1{
  \directlua{
    thirddata.literateProgs.addMainDocument('#1')
  }
}

\def\addSubDocument#1{
  \directlua{
    thirddata.literateProgs.addSubDocument('#1')
  }
}

\def\addDocumentDirectory#1{
  \directlua{
    thirddata.literateProgs.addDocumentDirectory('#1')
  }
}

\def\addConTeXtModuleDirectory#1{
  \directlua{
    thirddata.literateProgs.addConTeXtModuleDirectory('#1')
  }
}
\stopMkIVCode

\startLuaCode
local function addMainDocument(aDocument)
  build.mainDoc = aDocument
end

litProgs.addMainDocument = addMainDocument

local function addSubDocument(aDocument)
  build.subDocs = build.subDocs or { }
  tInsert(build.subDocs, aDocument)
end

litProgs.addSubDocument = addSubDocument

local function addDocumentDirectory(aDirectory)
  build.docDir   = aDirectory
  build.buildDir = aDirectory:gsub('[^/]+', '..')
end

litProgs.addDocumentDirectory = addDocumentDirectory

local function addConTeXtModuleDirectory(aDirectory)
  build.contextModuleDir = aDirectory
end

litProgs.addConTeXtModuleDirectory = addConTeXtModuleDirectory
\stopLuaCode

\startMkIVCode
\def\compileLakefile#1{
  \directlua{
    thirddata.literateProgs.compileLakefile('#1')
  }
}
\stopMkIVCode

\startLuaCode
local function addBuildTargets(lf)
  tInsert(lf, "-------------------------------------")
  tInsert(lf, "-- ADD build targets for each srcFile\n")
  tInsert(lf, "local buildTargets = {}\n")
  for i, aSrcFile in ipairs(build.srcTargets) do
    tInsert(lf, "tInsert(buildTargets, target(")
    tInsert(lf, "  'build/"..aSrcFile.."',")
    tInsert(lf, "  docFiles,")
    tInsert(lf, "  contextDoc")
    tInsert(lf, "))\n")
  end
end

local function addDiffTargets(lf)
  tInsert(lf, "------------------------------------")
  tInsert(lf, "-- ADD diff targets for each srcFile\n")
  tInsert(lf, "local diffTargets = {}\n")
  for i, aSrcFile in ipairs(build.srcTargets) do
    tInsert(lf, "tInsert(diffTargets, target(")
    tInsert(lf, "  'diff-"..aSrcFile.."',")
    tInsert(lf, "  'build/"..aSrcFile.."',")
    tInsert(lf, "  'diff build/"..aSrcFile.." "..build.contextModuleDir.."/"..aSrcFile.."'")
    tInsert(lf, "))\n")
  end
end

local function addInstallTargets(lf)
  tInsert(lf, "---------------------------------------")
  tInsert(lf, "-- ADD install targets for each srcFile\n")
  tInsert(lf, "local installTargets = {}\n")
  for i, aSrcFile in ipairs(build.srcTargets) do
    tInsert(lf, "tInsert(installTargets, target(")
    tInsert(lf, "  '"..build.contextModuleDir.."/"..aSrcFile.."',")
    tInsert(lf, "  'build/"..aSrcFile.."',")
    tInsert(lf, "  'cp build/"..aSrcFile.." "..build.contextModuleDir.."/"..aSrcFile.."'")
    tInsert(lf, "))\n")
  end
end

local function addLakefileTargets(lf)
  tInsert(lf, "-------------------------------")
  tInsert(lf, "-- ADD targets for the lakefile\n")
  tInsert(lf, "tInsert(buildTargets, target(")
  tInsert(lf, "  'build/lakefile',")
  tInsert(lf, "  docFiles,")
  tInsert(lf, "  contextDoc")
  tInsert(lf, "))\n")
  tInsert(lf, "tInsert(diffTargets, target(")
  tInsert(lf, "  'diff-lakefile',")
  tInsert(lf, "  'build/lakefile',")
  tInsert(lf, "  'diff build/lakefile lakefile'")
  tInsert(lf, "))\n")
  tInsert(lf, "tInsert(installTargets, target(")
  tInsert(lf, "  'lakefile',")
  tInsert(lf, "  'build/lakefile',")
  tInsert(lf, " 'cp build/lakefile lakefile'")
  tInsert(lf, "))\n")
end

local function compileLakefile(aCodeStream)
  texio.write(lPPrint(build))
  setCodeStream('Lakefile', aCodeStream)
  markCodeOrigin('Lakefile')
  local lf = {}
  tInsert(lf, "local tInsert    = table.insert\n")
  tInsert(lf, "local docDir     = '"..build.docDir.."'")
  tInsert(lf, "local moduleDir  = '"..build.contextModuleDir.."'\n")
  tInsert(lf, "local contextDoc = 'cd "..build.docDir.." ; context "..build.mainDoc.."'\n")
  tInsert(lf, 'local docFiles = {')
  tInsert(lf, "  '"..build.mainDoc.."',")
  for i, aSubDoc in ipairs(build.subDocs) do
    tInsert(lf, "  '"..aSubDoc.."',")
  end
  tInsert(lf, '}\n')
  tInsert(lf, "local srcFiles = {")
  for i, aSrcFile in ipairs(build.srcTargets) do
    tInsert(lf, "  '"..aSrcFile.."',")
  end
  tInsert(lf, '}\n')
  addBuildTargets(lf)
  addDiffTargets(lf)
  addInstallTargets(lf)
  addLakefileTargets(lf)
  setPrepend('Lakefile', aCodeStream, true)
  addCodeDefault('Lakefile', tConcat(lf, '\n'))
  lf = {}
  tInsert(lf, "target('install', installTargets)")
  tInsert(lf, "target('diff', diffTargets)")
  tInsert(lf, "default(buildTargets)")
  setPrepend('Lakefile', aCodeStream, false)
  addCodeDefault('Lakefile', tConcat(lf, '\n'))
end

litProgs.compileLakefile = compileLakefile
\stopLuaCode

\startLakefile
-- some additional lake file items
\stopLakefile

\stopchapter