% A ConTeXt document [master document: literateProgs.tex]

\startchapter[title=Lua Make System Files]

We use a simple recursive descent based make file system using lua to 
drive the creation of the various files required by any given 
\type{t-literate-progs} managed \ConTeXt\ program. 

\startMkIVCode
\def\addMainDocument#1{
  \directlua{
    thirddata.literateProgs.addMainDocument('#1')
  }
}

\def\addSubDocument#1{
  \directlua{
    thirddata.literateProgs.addSubDocument('#1')
  }
}

\def\ensureDirectoryExists#1{
  \directlua{
    thirddata.literateProgs.ensureDirectoryExists('#1')
  }
}

\def\addDocumentDirectory#1{
  \directlua{
    thirddata.literateProgs.addDocumentDirectory('#1')
  }
}

\def\addConTeXtModuleDirectory#1{
  \directlua{
    thirddata.literateProgs.addConTeXtModuleDirectory('#1')
  }
}

\def\addCCodeLibDirectory#1{%
  \directlua{
    thirddata.literateProgs.addCCodeLibDirectory('#1')
  }
}

\def\addCCodeLib#1{%
  \directlua{
    thirddata.literateProgs.addCCodeLib('#1')
  }
}
\stopMkIVCode

\startLuaCode
local function addMainDocument(aDocument)
  build.mainDoc = aDocument
end

litProgs.addMainDocument = addMainDocument

local function addSubDocument(aDocument)
  build.subDocs = build.subDocs or { }
  tInsert(build.subDocs, aDocument)
end

litProgs.addSubDocument = addSubDocument

local function ensureDirectoryExists(newDirectory)
--  newDirectory =
--    newDirectory:gsub('<HOME>', os.getenv('HOME'))
--  build.existingDirs = build.existingDirs or { }
  tInsert(build.existingDirs, newDirectory)
end

litProgs.ensureDirectoryExists = ensureDirectoryExists

local function addDocumentDirectory(aDirectory)
  build.docDir   = aDirectory
  build.buildDir = aDirectory:gsub('[^/]+', '..')
end

litProgs.addDocumentDirectory = addDocumentDirectory

local function addConTeXtModuleDirectory(aDirectory)
  build.contextModuleDir = aDirectory
end

litProgs.addConTeXtModuleDirectory = addConTeXtModuleDirectory

local function addCCodeLibDirectory(aDirectory)
  build.cCodeLibDirs = build.cCodeLibDirs or { }
  tInsert(build.cCodeLibDirs, aDirectory)
end

litProgs.addCCodeLibDirectory = addCCodeLibDirectory

local function addCCodeLib(aLib)
  build.cCodeLibs = build.cCodeLibs or { }
  tInsert(build.cCodeLibs, aLib)
end

litProgs.addCCodeLib = addCCodeLib
\stopLuaCode

\startMkIVCode
\def\compileLmsfile#1{
  \directlua{
    thirddata.literateProgs.compileLmsfile('#1')
  }
}
\stopMkIVCode

\startLuaCode
local function compileLmsfile(aCodeStream)
  setCodeStream('Lmsfile', aCodeStream)
  markCodeOrigin('Lmsfile')
  local lmsfile = {}
--  tInsert(lmsfile, "lfs = require 'lfs'\n")
--  build.existingDirs = build.existingDirs or { }
--  for i, aNewDir in ipairs(build.existingDirs) do
--    tInsert(lmsfile, "lfs.mkdir('"..aNewDir.."')")
--  end
--  tInsert(lmsfile, "")
  tInsert(lmsfile, "require 'lms.litProgs'\n")
  tInsert(lmsfile, "lpTargets = litProgs.targets{")
  tInsert(lmsfile, "  mainDoc  = '"..build.mainDoc.."',")
  tInsert(lmsfile, "  docFiles = {")
  for i, aSubDoc in ipairs(build.subDocs) do
    tInsert(lmsfile, "    '"..aSubDoc.."',")
  end
  tInsert(lmsfile, "  },")

  tInsert(lmsfile, "  docDir    = '"..build.docDir.."',")
  tInsert(lmsfile, "}")
  if build.srcTargets.ctxModule and 0 < #build.srcTargets.ctxModule then
    tInsert(lmsfile, "")
    tInsert(lmsfile, "require 'lms.contextMod'")
    tInsert(lmsfile, "")
    tInsert(lmsfile, "contextMod.targets(lpTargets, {")
      tInsert(lmsfile, "  moduleFiles = {")
      for i, aModFile in ipairs(build.srcTargets.ctxModule) do
        tInsert(lmsfile, "    '"..aModFile.."',")
      end
      tInsert(lmsfile, "  },")
      if build.contextModuleDir then
        tInsert(lmsfile, "  moduleDir = '"..build.contextModuleDir.."',")
      end
    tInsert(lmsfile, "})")
  end
  setPrepend('Lmsfile', aCodeStream, true)
  addCodeDefault('Lmsfile', tConcat(lmsfile, '\n'))
end

litProgs.compileLmsfile = compileLmsfile
\stopLuaCode

\startLmsfile
-- some additional lua make file items
\stopLmsfile

\stopchapter