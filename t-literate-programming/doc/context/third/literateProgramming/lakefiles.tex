% A ConTeXt document [master document: literateProgramming.tex]

\startchapter[title=Lakefile]

We use a slightly updated version of Steve Donovan's Lakefile tool to 
drive the creation of the various files required by any given 
\type{t-literate-modules} managed \ConTeXt\ module. 

\startMkIVCode

%D \section{Lakefile environment}

%D \subsection{Implementation: start}

\definetyping[Lakefile]
\setuptyping[Lakefile][option=lua]

%D \subsection{Implementation: stop}

\let\oldStopLakefile=\stopLakefile
\def\stopLakefile{%
  \oldStopLakefile%
  \directlua{thirddata.literateModules.addLakefile('_typing_')}}

%D \subsection{Implementation: create file}

\def\createLakefile[#1]{
  \directlua{thirddata.literateModules.createLakefile('#1')}
}

\stopMkIVCode

\startLuaCode

function litMods.addLakefile(bufferName)
  local bufferContents = buffers.getcontent(bufferName):gsub("\13", "\n")
  table_insert(code.lakefile, bufferContents)
end

function litMods.createLakefile(aFilePath)
  renderFile(aFilePath, litMods.templates.lakefile.file)
end

\stopLuaCode

\startLuaTemplate

templates.lakefile.file = [=[
{{ return table.concat(thirddata.literateModules.code.lakefile, "\n\n") }}
]=]

\stopLuaTemplate

\startLakefile
-- A Lua Lakefile

local docDir    =
  't-literate-programming/doc/context/third/literateProgramming'
local moduleDir =
  't-literate-programming/tex/context/third/literateProgramming'
local srcFiles = {
  docDir..'/literateProgramming.tex',
  docDir..'/overview.tex',
  docDir..'/preamble.tex',
  docDir..'/rendering.tex',
  docDir..'/mkivCode.tex',
  docDir..'/mkivTests.tex',
  docDir..'/luaCode.tex',
  docDir..'/luaTests.tex',
  docDir..'/luaTemplates.tex',
  docDir..'/luaTemplateTests.tex',
  docDir..'/lakefiles.tex',
  docDir..'/conclusion.tex'
}

local contextDoc = 
  'cd '..docDir..' ; context literateProgramming.tex '

local moduleTargets = {
  't-literate-programming.mkiv',
  't-literate-programming.lua',
  't-literate-programming-templates.lua'
}

local buildTargets   = { }
local diffTargets    = { }
local installTargets = { }

for i, aTarget in ipairs(moduleTargets) do

  table.insert(buildTargets, target(
    'build/'..aTarget,
    srcFiles,
    contextDoc
  ))

  table.insert(diffTargets, target(
    'diff-'..aTarget,
    'build/'..aTarget,
    'diff $(DEPENDS) '..moduleDir..'/'..aTarget
  ))

  table.insert(installTargets, target(
    moduleDir..'/'..aTarget,
    'build/'..aTarget,
    'cp $(DEPENDS) $(TARGET)'
  ))
end

table.insert(buildTargets, target(
  'build/lakefile',
  srcFiles,
  contextDoc
))

table.insert(diffTargets, target(
  'diff-lakefile',
  'build/lakefile',
  'diff $(DEPENDS) lakefile'
))

table.insert(installTargets, target(
  'lakefile',
  'build/lakefile',
  'cp $(DEPENDS) $(TARGET)'
))

target('install', installTargets)

target('diff', diffTargets)

default(buildTargets)

\stopLakefile

\stopchapter